{"ast":null,"code":"import Settings from './settings';\nimport C from './constants';\nimport { getRandomFigure } from './figure';\nexport const makeInitialState = function () {\n  const blocksMap = [];\n\n  for (let i = 0; i < Settings.stageSize.height; i++) {\n    blocksMap.push(Array(Settings.stageSize.width));\n  }\n\n  return {\n    figure: getRandomFigure(),\n    nextFigure: getRandomFigure(),\n    blocksMap: blocksMap,\n    gameStatus: {\n      score: 0,\n      gameOver: false\n    }\n  };\n};\n\nconst positionsEqual = function (p1, p2) {\n  return p1.x === p2.x && p1.y === p2.y;\n};\n\nexport function blocksReducer(state, action) {\n  const {\n    figure,\n    nextFigure,\n    blocksMap,\n    gameStatus\n  } = state;\n\n  if (!figure) {\n    return { ...state,\n      figure: nextFigure,\n      nextFigure: getRandomFigure()\n    };\n  }\n\n  const oldPositions = figure.blocks;\n  const newFigure = moveFigure(figure, action.type);\n  const newPositions = newFigure.blocks;\n  let isStuck = false;\n\n  try {\n    isStuck = newPositions.some(block => blocksMap[block.y][block.x]);\n  } catch (error) {\n    console.log(error);\n    return state;\n  }\n\n  const samePositions = newPositions.every((block, i) => positionsEqual(block, oldPositions[i]));\n\n  if (action.type === C.DOWN) {\n    if (isStuck || samePositions) {\n      const newBlocksMap = blocksMap.slice();\n\n      for (let block of oldPositions) {\n        newBlocksMap[block.y][block.x] = figure.color;\n      }\n\n      const reducedBlocksMap = reduceFullRows(newBlocksMap);\n      return {\n        figure: nextFigure,\n        nextFigure: getRandomFigure(),\n        blocksMap: reducedBlocksMap,\n        gameStatus: {\n          score: gameStatus.score + 1,\n          gameOver: isGameOver(reducedBlocksMap)\n        }\n      };\n    } else {\n      return { ...state,\n        figure: newFigure\n      };\n    }\n  } else {\n    return { ...state,\n      figure: isStuck ? figure : newFigure\n    };\n  }\n}\n\nfunction reduceFullRows(blocksMap) {\n  const withoutFullRows = blocksMap.filter(row => row.filter(b => Boolean(b)).length < Settings.stageSize.width);\n  const numberOfRowsToAdd = Settings.stageSize.height - withoutFullRows.length;\n  const emptyRows = [];\n\n  for (let i = 0; i < numberOfRowsToAdd; i++) {\n    emptyRows[i] = Array(Settings.stageSize.width);\n  }\n\n  return emptyRows.concat(withoutFullRows);\n}\n\nfunction isGameOver(blocksMap) {\n  return blocksMap[0].filter(block => Boolean(block)).length > 0;\n}\n\nfunction moveFigure(figure, action) {\n  const {\n    x,\n    y\n  } = figure.position;\n\n  switch (action) {\n    case C.LEFT:\n      return figure.move({\n        x: x - 1,\n        y\n      });\n\n    case C.RIGHT:\n      return figure.move({\n        x: x + 1,\n        y\n      });\n\n    case C.DOWN:\n      return figure.move({\n        x,\n        y: y + 1\n      });\n\n    case C.ROTATE:\n      return figure.rotate();\n\n    default:\n      return figure;\n  }\n}","map":{"version":3,"sources":["/home/ovo/projects/my-app/src/gamelogic.js"],"names":["Settings","C","getRandomFigure","makeInitialState","blocksMap","i","stageSize","height","push","Array","width","figure","nextFigure","gameStatus","score","gameOver","positionsEqual","p1","p2","x","y","blocksReducer","state","action","oldPositions","blocks","newFigure","moveFigure","type","newPositions","isStuck","some","block","error","console","log","samePositions","every","DOWN","newBlocksMap","slice","color","reducedBlocksMap","reduceFullRows","isGameOver","withoutFullRows","filter","row","b","Boolean","length","numberOfRowsToAdd","emptyRows","concat","position","LEFT","move","RIGHT","ROTATE","rotate"],"mappings":"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","sourcesContent":["import Settings from './settings'\nimport C from './constants'\nimport { getRandomFigure } from './figure'\n\nexport const makeInitialState = function() {\n\tconst blocksMap = [];\n\n\tfor (let i = 0; i < Settings.stageSize.height; i++) {\n\t\tblocksMap.push(Array(Settings.stageSize.width));\n\t}\n\n\treturn {\n\t\tfigure : getRandomFigure(),\n\t\tnextFigure : getRandomFigure(),\n\t\tblocksMap: blocksMap,\n\t\tgameStatus: {\n\t\t\tscore: 0,\n\t\t\tgameOver: false\n\t\t}\n\t}\n}\n\nconst positionsEqual = function(p1, p2) {\n\treturn p1.x === p2.x && p1.y === p2.y\n}\n\nexport function blocksReducer(state, action) {\n\tconst { figure, nextFigure, blocksMap, gameStatus } = state\n\tif (!figure) {\n\t\treturn {\n\t\t\t...state,\n\t\t\tfigure: nextFigure,\n\t\t\tnextFigure: getRandomFigure(),\n\t\t}\n\t}\n\n\tconst oldPositions = figure.blocks;\n\n\tconst newFigure = moveFigure(figure, action.type)\n\tconst newPositions = newFigure.blocks;\n\n\tlet isStuck = false; \n\ttry {\n\t\tisStuck = newPositions.some(\n\t\t\tblock => blocksMap[block.y][block.x]\n\t\t);\n\n\t} catch (error) {\n\t\tconsole.log(error);\n\t\treturn state\n\t}\n\n\tconst samePositions = newPositions.every(\n\t\t(block, i) => positionsEqual(block, oldPositions[i])\n\t);\n\n\tif (action.type === C.DOWN) {\n\t\tif (isStuck || samePositions) {\n\t\t\tconst newBlocksMap = blocksMap.slice();\n\t\t\tfor (let block of oldPositions) {\n\t\t\t\tnewBlocksMap[block.y][block.x] = figure.color;\n\t\t\t}\n\n\t\t\tconst reducedBlocksMap = reduceFullRows(newBlocksMap);\n\n\t\t\treturn {\n\t\t\t\tfigure: nextFigure,\n\t\t\t\tnextFigure: getRandomFigure(),\n\t\t\t\tblocksMap: reducedBlocksMap,\n\t\t\t\tgameStatus: {\n\t\t\t\t\tscore: gameStatus.score + 1,\n\t\t\t\t\tgameOver: isGameOver(reducedBlocksMap)\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\tfigure: newFigure,\n\t\t\t}\n\t\t}\n\t} else {\n\t\treturn {\n\t\t\t...state,\n\t\t\tfigure: isStuck ? figure : newFigure,\n\t\t};\n\t}\n}\n\nfunction reduceFullRows(blocksMap) {\n\tconst withoutFullRows = blocksMap.filter(row => \n\t\trow.filter(b => Boolean(b)).length < Settings.stageSize.width\n\t);\n\tconst numberOfRowsToAdd = Settings.stageSize.height - withoutFullRows.length;\n\tconst emptyRows = [];\n\tfor (let i = 0; i < numberOfRowsToAdd; i ++) {\n\t\temptyRows[i] = Array(Settings.stageSize.width)\n\t}\n\treturn emptyRows.concat(withoutFullRows);\n}\n\nfunction isGameOver(blocksMap) {\n\treturn blocksMap[0].filter(block => Boolean(block)).length > 0;\n}\n\nfunction moveFigure(figure, action) {\n\tconst { x, y } = figure.position;\n\tswitch (action) {\n\t\tcase C.LEFT:\n\t\t\treturn figure.move({ x: x - 1, y });\n\t\tcase C.RIGHT:\n\t\t\treturn figure.move({ x: x + 1, y });\n\t\tcase C.DOWN:\n\t\t\treturn figure.move({ x, y: y + 1 });\n\t\tcase C.ROTATE:\n\t\t\treturn figure.rotate();\n\t\tdefault:\n\t\t\treturn figure;\n\t}\n}\n"]},"metadata":{},"sourceType":"module"}